@echo off
setlocal enabledelayedexpansion
set index=\p\ytdemv3\source\nts_index_50k_dd.shp
set index=\p\ytdemv3\source\\nts_index_50k_dd_buf-3x.shp
REM set tiles=117D 117A 116O 116P 116J 116I 106L 116G 116H 106E 106F 116B 116A 106D 106B 106C 115O 115P 105M 105O 105N 115J 115I 105I 105L 105J 105K 115G 095E 115H 105H 105E 105G 105F 095C 115B 095D 115A 105A 105D 105B 105C 
REM set tiles=117C09 117D12 117C08 117D05 117D06 117C01 117D04 117D03 117D02 117B16 117A13 117A14 117A15 117A16 117B09 117A12 117A11 117A10 117A09 117B08 117A05 117A06 117A07 117A08 117B01 117A04 117A03 117A02 117A01 116N15 116N16 116O13 116O14 116O15 116O16 116P13 116P14 116P15 116P16 116N10 116N09 116O12 116O11 116O10 116O09 116P12 116P11 116P10 116P09 106M12 116N07 116N08 116O05 116O06 116O07 116O08 116P05 116P06 116P07 116P08 106M05 116N02 116N01 116O04 116O03 116O02 116O01 116P04 116P03 116P02 116P01 106M04 106M03 106M02 106M01 106N04 116K15 116K16 116J13 116J14 116J15 116J16 116I13 116I14 116I15 116I16 106L13 106L14 106L15 106L16 106K13 106K14 116K10 116K09 116J12 116J11 116J10 116J09 116I12 116I11 116I10 116I09 106L12 106L11 106L10 106L09 106K12 106K11 116K07 116K08 116J05 116J06 116J07 116J08 116I05 116I06 116I07 116I08 106L05 106L06 106L07 106L08 106K05 106K06 116K02 116K01 116J04 116J03 116J02 116J01 116I04 116I03 116I02 116I01 106L04 106L03 106L02 106L01 106K04 106K03 106K01 106K02 116F15 116F16 116G13 116G14 116G15 116G16 116H13 116H14 116H15 116H16 106E13 106E14 106E15 106E16 106F13 106G13 106F14 106F16 106F15 116F10 116F09 116G12 116G11 116G10 116G09 116H12 116H11 116H10 116H09 106E12 106E11 106E10 106E09 106F12 106G12 106F11 106F09 106F10 116F07 116F08 116G05 116G06 116G07 116G08 116H05 116H06 116H07 116H08 106E05 106E06 106E07 106E08 106F05 106G05 106F06 106F08 106F07 116F02 116F01 116G04 116G03 116G02 116G01 116H04 116H03 116H02 116H01 106E04 106E03 106E02 106E01 106F04 106G04 106F03 106F01 106F02 116C15 116C16 116B13 116B14 116B15 116B16 116A13 116A14 116A15 116A16 106D13 106D14 106D15 106D16 106C13 106B13 106C14 106C16 106C15 116C10 116C09 116B12 116B11 116B10 116B09 116A12 116A11 116A10 116A09 106D12 106D11 106D10 106D09 106B11 106C12 106B12 106C11 106C09 106C10 116C07 116C08 116B05 116B06 116B07 116B08 116A05 116A06 116A07 116A08 106D05 106D06 106D07 106B07 106D08 106B06 106C05 106B05 106C06 106C08 106C07 116C02 116C01 116B04 116B03 116B02 116B01 116A04 116A03 116A02 116A01 106D04 106D03 106B01 106D02 106B02 106D01 106B03 106C04 106B04 106C03 106C01 106C02 115N15 115N16 115O13 115O14 115O15 115O16 115P13 115P14 115P15 115P16 105M13 105P13 105M14 105O16 105M15 105O15 105M16 105O14 105N13 105O13 105N14 115N10 105N16 105N15 115N09 115O12 115O11 115O10 115O09 115P12 115P11 115P10 115P09 105M12 105P12 105M11 105O09 105M10 105O10 105M09 105O11 105N12 115N07 105O12 105N11 105N09 105N10 115N08 115O05 115O06 115O07 115O08 115P05 115P06 115P07 115P08 105M05 105P05 105M06 105O08 105M07 105O07 105M08 105O06 105N05 115N02 105O05 105N06 105N08 105N07 115N01 115O04 115O03 115O02 115O01 115P04 115P03 115P02 115P01 105P03 105M04 105P04 105M03 105O01 105M02 105O02 105M01 115K15 105O03 105N04 105O04 105N03 105N01 105N02 115K16 115J13 115J14 115J15 115J16 115I13 115I14 115I15 115I16 105I14 105L13 105I13 105L14 105J16 105L15 105J15 105L16 115K10 105J14 105K13 105J13 105K14 105K16 105K15 115K09 115J12 115J11 115J10 115J09 115I12 115I11 115I10 105I10 115I09 105I11 105L12 105I12 105L11 105J09 105L10 105J10 105L09 115K07 105J11 105K12 105J12 105K11 105K09 105K10 115K08 115J05 115J06 115J07 115J08 115I05 115I06 105I08 115I07 105I07 115I08 105I06 105L05 105I05 105L06 105J08 105L07 115K02 105J07 105L08 105J06 105K05 105J05 105K06 105K08 105K07 115K01 115J04 115J03 115J02 115J01 115I04 095L04 115I03 105I01 115I02 105I02 115I01 105I03 105L04 105I04 105L03 105J01 105L02 115F15 105J02 105L01 105J03 105K04 105J04 105K03 105K01 105K02 115F16 115G13 115G14 115G15 115G16 095E14 115H13 095E13 115H14 105H16 115H15 105H15 115H16 105H14 105E13 105H13 105E14 105G16 105E15 115F10 105G15 105E16 105G14 105F13 105G13 105F14 105F16 105F15 115F09 115G12 115G11 115G10 095E10 115G09 095E11 115H12 095E12 115H11 105H09 115H10 105H10 115H09 105H11 105E12 105H12 105E11 105G09 105E10 115F07 105G10 105E09 105G11 105F12 105G12 105F11 105F09 105F10 115F08 115G05 115G06 115G07 095E07 115G08 095E06 115H05 095E05 115H06 105H08 115H07 105H07 115H08 105H06 105E05 105H05 105E06 095F01 115F02 105G08 105E07 105G07 105E08 105G06 105F05 105G05 105F06 105F08 105F07 095F02 115F01 095F03 115G04 115G03 095F04 115G02 095E01 095E02 115G01 095E03 115H04 095E04 115H03 105H01 115H02 105H02 115H01 105H03 105E04 105H04 105E03 095C16 115C15 105G01 105E02 105G02 105E01 105G03 105F04 105G04 105F03 105F01 105F02 095C15 115C16 095C14 115B13 115B14 095C13 115B15 095D16 095D15 115B16 095D14 115A13 095D13 115A14 105A16 115A15 095B12 105A15 115A16 105A14 105D13 105A13 105D14 095C09 115C10 105B16 105D15 105B15 105D16 105B14 105C13 105B13 105C14 105C16 105C15 095C10 115C09 095C11 115B12 115B11 095C12 115B10 095D09 095D10 115B09 095D11 115A12 095D12 115A11 105A09 115A10 095B05 105A10 115A09 105A11 105D12 105A12 105D11 095C08 115C07 105B09 105D10 105B10 105D09 105B11 105C12 105B12 105C11 105C09 105C10 095C07 115C08 095C06 115B05 115B06 095C05 115B07 095D08 095D07 115B08 095D06 115A05 095B03 095D05 115A06 105A08 115A07 095B04 105A07 115A08 105A06 105D05 105A05 105D06 095C01 105B08 105D07 105B07 105D08 105B06 105C05 105B05 105C06 095C02 105C08 105C07 095C03 115B03 095C04 115B02 095D01 095D02 115B01 095D03 115A04 094O14 095D04 115A03 105A01 115A02 094O13 105A02 115A01 105A03 105D04 094N16 105A04 105D03 105B01 105D02 105B02 105D01 105B03 105C04 105B04 105C03 094N15 105C01 105C02 094N14 094N13 114O15 094M16 094M15 114O16 094M14 114P13 094M13 114P14 104P16 114P15 104P15 114P16 104P14 104M13 104P13 104M14 104O16 104M15 104O15 104M16 104O14 104N13 104O13 104N14 104N16 104N15 
REM set tiles=106C01 106C02 106C03
REM set tiles=105E
set copts= -co compress=lzw -co predictor=2 -co tiled=yes
REM set wopts= -wo optimize_size=yes -wo num_threads=all_cpus -wm 15gb -multi
set wopts= -r cubic -multi -wo optimize_size=yes
REM set csrs=GEOGCS["NAD83(CSRS)",DATUM["NAD83 Canadian Spatial Reference System",SPHEROID["GRS 1980",6378137.0,298.257222101,AUTHORITY["EPSG","7019"]],TOWGS84[-0.991,1.9072,0.5129,0.0257899075194932,-0.009650098960270402,-0.011659943232342112,0.0],AUTHORITY["EPSG","6140"]],PRIMEM["Greenwich",0.0,AUTHORITY["EPSG","8901"]],UNIT["degree",0.017453292519943295],AXIS["Geodetic latitude",NORTH],AXIS["Geodetic longitude",EAST],AXIS["Ellipsoidal height",UP],AUTHORITY["EPSG","4955"]]
set csrs=nad83

if "%1"=="" goto :Usage
set tiles=%1

:: 0.75 arc-seconds expressed in decimal degrees, ~15-25m
set pxsize=0.0002083333 0.0002083333

set infile=%2
set prefix=%3

set projected_file=%csrs%_%infile%.vrt
call :project %csrs% !infile! !projected_file!

:: Expand a single 250k NTS quad to 50k tiles
call :250k_to_50k

for %%a in (%tiles%) do (
  set tile=%%a
  
  set cropped_file=cropped_!tile!_!projected_file!
  call :crop !projected_file! !cropped_file! !tile!
  
  rem Remove nodata collar
  set final_file=!prefix!_%%a.tif
  REM call autocrop-raster !cropped_file! !final_file!
  call :translate !cropped_file! !final_file!
  )

endlocal
goto :eof
:: --------------------------------------------------------------------
:250k_to_50k
  :: Expand a single 250k NTS quad to 50k tiles
  :: 106C --> 106C01 106C02 106C03 106C04
  for %%t in (!tiles!) do (
  if "%%t"=="!tiles!" set tiles=%%t01
    for %%i in (02,03,04,05,06,07,08,09,10,11,12,13,14,15,16) do (
      set tiles=!tiles! %%t%%i
      )
    )
  echo !tiles!
  goto :eof
  
:project
  :: project to target coordsys and pixel size, virtual format
  setlocal
  set coordsys=%1
  set infile=%2
  set outfile=%3
  if not exist !outfile! (@gdalwarp %copts% %wopts% -t_srs %coordsys% ^
    -tr %pxsize% -of vrt ^
    %infile% %outfile% ) else (
    echo --- skipping pre-existing !outfile!)
  endlocal
  goto :eof

:crop
  setlocal
  set infile=%1
  set outfile=%2
  set tile=%3
  if not exist !outfile! (@gdalwarp %copts% %wopts% -of vrt -cblend 3 ^
    -cutline %index% -cwhere "'TILE_NAME' = '%tile%'" ^
    -crop_to_cutline ^
    %infile% %outfile% ) else (
    echo --- skipping pre-existing !outfile!)
  endlocal
  goto :eof

:translate
  setlocal
  set infile=%1
  set outfile=%2
  if not exist !outfile! (gdal_translate %copts% !infile! !outfile!) else (
    echo --- skipping pre-existing !outfile!)
  endlocal
  goto :eof
  
:Old_Method
  gdalwarp -cutline %index% ^
  -cwhere "'TILE_NAME' = '%%a'" ^
  -cblend 30 ^
  -crop_to_cutline ^
  -r cubic ^
  -t_srs %csrs% ^
  -tr %pxsize% ^
  %copts% ^
  %wopst% ^
  -of vrt ^
  !infile! xx!prefix!_%%a.vrt
  goto :eof

:Usage
  echo.
  echo. ---{%0}---
  echo.
  echo.     %~n0 [250k NTS TILE] [in_dem_raster] {out_name_prefix}
  echo.
  echo.     %~n0 115G dem_30m.tif
  echo.
  goto :eof
  
  
:: --- Notes ---
Warp options reference:
  http://www.gdal.org/structGDALWarpOptions.html#a0ed77f9917bb96c7a9aabd73d4d06e08

EPSG:4955 - NAD83(CSRS) with vertical
http://spatialreference.org/ref/epsg/4955/html/

  